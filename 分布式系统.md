# 知识来源

- MIT 6.824 分布式系统
- DDIA

# GFS

# Raft

# Zookeeper

# 分布式事务

# Spanner

Google过去使用MySQL和BigTable提供Web和广告服务，维护这些数据的分片很耗时，并且很需要强一致性。之前的广告系统不支持使用事务，Spanner想要解决的问题是全球的强一致性数据库系统，这个系统使用了两个巧妙的思想：

- 使用Paxos解决2PC事务协调器的容错问题。
- 使用同步时间实现了高效的只读事务。

Google提供了Spanner的云服务。Spanner主要用于只读事务，因为Google的广告业务只读事务超过十亿，而读写事务只有几百万。

## 架构

不同的数据中心通过机器部署这Spanner服务，然后每个数据中心都维护了数据的副本，相同数据的副本一致性构成了Paxos组，使用Paxos维护数据的一致性。数据中心的机器也部署了Spanner的客户端，用来读取本地机器的数据。

## 读写事务

当一个事务修改X和读取Y数据时，Spanner会在这两个数据所在的Paxos选出Leader，并且在这些Leader中选出一个作为事务协调器。并将写请求发送给Leader，Leader向所在的Paxos组的其他机器发送准备消息，然后Leader告诉事务协调器可以接收写入，事务协调器就会提交这个事务。多个Leader中的其他Leader作为备选的事务协调器，实现了高效与灾备。

Spanner使用完全标准的两阶段锁保证了事务的有序性，并且使用两阶段提交来保证事务的分布式能力。Spanner通过Paxos算法消除了两阶段提交的Leader崩溃问题，同时也解决了事务协调器持有两阶段锁发生故障导致阻塞的问题。

上面的实现存在的问题是整个拓扑存在大量的消息，这些消息跨域具备不同地理位置的数据中心，因为这些单节点上运行数纳秒的计算在Spanner变成毫秒，甚至秒。

## 只读事务

只读事务不会导致消息过多问题，Spanner消除了读写事务中的两个巨大成本的问题：

- 只读事务可以从本地读取数据，跨国读取数据可能需要更高的延迟，本地读取可能不是最新的数据。
- 没有使用2PL和2PC，并且没有使用事务管理器，这避免了联系Paxos组。

Spanner具备快照隔离级别，因为读写事务会对只读事务造成影响，Spanner为每个事务分配时间戳：

- 读写事务的时间戳是事务提交的时间。
- 只读事务的时间戳是事务执行的时间。
